// ------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version: 10.0.0.0
//  
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
// ------------------------------------------------------------------------------
namespace MParse.OutputGenerators
{
    using MParse.Core.GrammarElements;
    using MParse.Core;
    using System.Linq;
    using System;
    
    
    #line 1 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
    [System.CodeDom.Compiler.GeneratedCodeAttribute("Microsoft.VisualStudio.TextTemplating", "10.0.0.0")]
    public partial class ParserTemplate : ParserCodeGenBase
    {
        public override string TransformText()
        {
            this.Write(" \r\nnamespace ");
            
            #line 5 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(_codeNamespace));
            
            #line default
            #line hidden
            this.Write("\r\n{\r\n    using System;\r\n    using System.Linq;\r\n    using System.Collections.Gene" +
                    "ric;\r\n\r\n    public class Parser \r\n    {\r\n        public ");
            
            #line 13 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.TreeNode));
            
            #line default
            #line hidden
            this.Write(" Parse(IEnumerable<");
            
            #line 13 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.TerminalBaseClassName));
            
            #line default
            #line hidden
            this.Write(@"> tokens)
        {
            var tokenEnumerator = tokens.GetEnumerator();
            if (!tokenEnumerator.MoveNext())
                throw new ArgumentException(""Cannot access tokens."", ""tokens"");

            var stateStack = new Stack<int>();
            var parseStack = new Stack<");
            
            #line 20 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.TreeNode));
            
            #line default
            #line hidden
            this.Write(@">();
            stateStack.Push(0);

            while(true)
            {
                var t = tokenEnumerator.Current;
                var result = t.Action(stateStack, parseStack);
                if ((result == ActionResult.Accept))
                {
                    break;
                }
                if (result == ActionResult.ShiftContinue)
                {
                    tokenEnumerator.MoveNext();
                    continue;
                }
                if (result == ActionResult.ReduceContinue)
                {
                    var reducer = ((");
            
            #line 38 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.ReductionInterfaceName));
            
            #line default
            #line hidden
            this.Write(@")(parseStack.Peek()));
                    reducer.Goto(stateStack);
                    continue;
                }
                if (result == ActionResult.Error)
                {
                    throw new Exception(""Parsing Failed."");
                }
            }
            return (");
            
            #line 47 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.TreeNode));
            
            #line default
            #line hidden
            this.Write(")parseStack.Pop();\r\n        }\r\n    }\r\n\r\n\tpublic abstract class TreeVisitorBase\r\n " +
                    "   {\r\n");
            
            #line 53 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

foreach(var symbol in _symbols)
{
if(symbol is Terminal)
{
if(symbol.Name.StartsWith("$"))
continue;

            
            #line default
            #line hidden
            this.Write("\r\n        public virtual void Visit(");
            
            #line 62 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(symbol.Name));
            
            #line default
            #line hidden
            this.Write(" terminal)\r\n\t\t{\r\n\r\n\t\t}\r\n");
            
            #line 66 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

}
else
{
foreach(var prod in _productions.Where(x => x.Head == symbol))
{
if(prod.Head.Name.StartsWith("$"))
continue;
var className = GetClassName(prod);

            
            #line default
            #line hidden
            this.Write("        public virtual void Visit(");
            
            #line 76 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(className));
            
            #line default
            #line hidden
            this.Write(" nonTerminal)\r\n\t\t{\r\n");
            
            #line 78 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

for(int i = 0; i < prod.Length; i++)
{

            
            #line default
            #line hidden
            this.Write("\t\t\tnonTerminal.T");
            
            #line 82 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            
            #line default
            #line hidden
            this.Write(".AcceptVisitor(this);\r\n");
            
            #line 83 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

}

            
            #line default
            #line hidden
            this.Write("\t\t}\r\n");
            
            #line 87 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

}
}
}

            
            #line default
            #line hidden
            this.Write("    }\r\n\r\n\t\r\n\r\n    public abstract class ");
            
            #line 96 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.TreeNode));
            
            #line default
            #line hidden
            this.Write("\r\n    {\r\n        private Guid _nodeId;\r\n\r\n        public ");
            
            #line 100 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.TreeNode));
            
            #line default
            #line hidden
            this.Write("()\r\n        {\r\n            _nodeId = Guid.NewGuid();\r\n        }\r\n\r\n        public" +
                    " virtual void AcceptVisitor(IParseTreeVisitor visitor)\r\n        {\r\n            /" +
                    "/No default implementation\r\n        }\r\n    }\r\n    \r\n    public abstract class ");
            
            #line 111 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.TerminalBaseClassName));
            
            #line default
            #line hidden
            this.Write(" : ");
            
            #line 111 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.TreeNode));
            
            #line default
            #line hidden
            this.Write("\r\n    {\r\n        private string _text;\r\n        \r\n        protected ");
            
            #line 115 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.TerminalBaseClassName));
            
            #line default
            #line hidden
            this.Write(@"(string text)
        {
            _text = text;
        }
        
        public string Text
        {
            get
            {
                return _text;
            }
        }
        
        public abstract ActionResult Action(Stack<int> stateStack, Stack<");
            
            #line 128 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.TreeNode));
            
            #line default
            #line hidden
            this.Write(@"> parseStack);
        
        public override string ToString()
        {
            return _text;
        }
    }

    public enum ActionResult
    {
        Error,
        Accept,
        ShiftContinue,
        ReduceContinue,
    }

    public interface ");
            
            #line 144 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.ReductionInterfaceName));
            
            #line default
            #line hidden
            this.Write("\r\n    {\r\n        void Goto(Stack<int> stateStack);\r\n    }\r\n\r\n");
            
            #line 149 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

foreach (var symbol in _symbols)
{
if (symbol is Terminal)
{
if(symbol.Name.StartsWith("$"))
continue;

            
            #line default
            #line hidden
            this.Write("    public partial class ");
            
            #line 157 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(symbol.Name));
            
            #line default
            #line hidden
            this.Write(" : ");
            
            #line 157 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.TerminalBaseClassName));
            
            #line default
            #line hidden
            this.Write("\r\n    {\r\n        public ");
            
            #line 159 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(symbol.Name));
            
            #line default
            #line hidden
            this.Write("(string text) : base(text)\r\n        {\r\n        }\r\n\r\n\t\tpublic override void Accept" +
                    "Visitor(TreeVisitorBase visitor)\r\n        {\r\n            visitor.Visit(this);\r\n " +
                    "       }\r\n\r\n        public override ActionResult Action(Stack<int> stateStack, S" +
                    "tack<");
            
            #line 168 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.TreeNode));
            
            #line default
            #line hidden
            this.Write("> parseStack)\r\n        {\r\n            int currentState = stateStack.Peek();\r\n");
            
            #line 171 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

foreach (var state in _table.StateMap.States)
{
var action = _table[state, symbol];
if (action.Action == ParserAction.Error)
{
continue;
}

            
            #line default
            #line hidden
            this.Write("            if(currentState == ");
            
            #line 180 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(state.StateId));
            
            #line default
            #line hidden
            this.Write(")\r\n            {\r\n");
            
            #line 182 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

if (action.Action == ParserAction.Shift)
{

            
            #line default
            #line hidden
            this.Write("                stateStack.Push(");
            
            #line 186 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(action.NextState.StateId));
            
            #line default
            #line hidden
            this.Write(");\r\n                parseStack.Push(this);\r\n                return ActionResult.S" +
                    "hiftContinue;\r\n");
            
            #line 189 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

}

            
            #line default
            #line hidden
            
            #line 192 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

if (action.Action == ParserAction.Reduce)
{

            
            #line default
            #line hidden
            this.Write("                parseStack.Push(");
            
            #line 196 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(GetClassName(action.ReduceByProduction)));
            
            #line default
            #line hidden
            this.Write(".");
            
            #line 196 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.ReduceByMethodName));
            
            #line default
            #line hidden
            this.Write("(parseStack));\r\n");
            
            #line 197 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

for (int i = 0; i < action.ReduceByProduction.Length; i++)
{

            
            #line default
            #line hidden
            this.Write("                stateStack.Pop();\r\n");
            
            #line 202 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

}

            
            #line default
            #line hidden
            this.Write("                return ActionResult.ReduceContinue;\r\n");
            
            #line 206 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

}

            
            #line default
            #line hidden
            
            #line 209 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

if (action.Action == ParserAction.Accept)
{

            
            #line default
            #line hidden
            this.Write("                return ActionResult.Accept;\r\n");
            
            #line 214 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

}

            
            #line default
            #line hidden
            this.Write("            }\r\n");
            
            #line 218 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

}

            
            #line default
            #line hidden
            this.Write("\t\t\treturn ActionResult.Error;\r\n        }\r\n    }\r\n\r\n");
            
            #line 225 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

}
else
{
if(symbol.Name.StartsWith("$"))
continue;

            
            #line default
            #line hidden
            this.Write("    public abstract class ");
            
            #line 232 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(symbol.Name));
            
            #line default
            #line hidden
            this.Write(" : ");
            
            #line 232 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.TreeNode));
            
            #line default
            #line hidden
            this.Write(", ");
            
            #line 232 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.ReductionInterfaceName));
            
            #line default
            #line hidden
            this.Write("\r\n    {\r\n        public void Goto(Stack<int> stateStack)\r\n        {\r\n            " +
                    "int currentState = stateStack.Peek();\r\n");
            
            #line 237 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

foreach (var state in _table.StateMap.States)
{
var action = _table[state, symbol];
if (action.Action == ParserAction.Goto)
{

            
            #line default
            #line hidden
            this.Write("            if(currentState == ");
            
            #line 244 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(state.StateId));
            
            #line default
            #line hidden
            this.Write(")\r\n            {\r\n                stateStack.Push(");
            
            #line 246 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(action.NextState.StateId));
            
            #line default
            #line hidden
            this.Write(");\r\n                return;\r\n            }\r\n");
            
            #line 249 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

}
}

            
            #line default
            #line hidden
            this.Write("            throw new Exception(\"Unexpected GOTO operation.\");\r\n        }\r\n    }\r" +
                    "\n\r\n");
            
            #line 257 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

}
}

            
            #line default
            #line hidden
            
            #line 261 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

foreach(var symbol in _symbols.Where(x => x is NonTerminal))
foreach(var prod in _productions.Where(x => x.Head == symbol ))
{
if(prod.Head.Name.StartsWith("$"))
continue;
var className = GetClassName(prod);

            
            #line default
            #line hidden
            this.Write("    public partial class ");
            
            #line 269 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(className));
            
            #line default
            #line hidden
            this.Write(" : ");
            
            #line 269 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(prod.Head));
            
            #line default
            #line hidden
            this.Write("\r\n    {\r\n");
            
            #line 271 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

for(int i = 0; i < prod.Length; i++)
{

            
            #line default
            #line hidden
            this.Write("        public ");
            
            #line 275 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(prod[i].Name));
            
            #line default
            #line hidden
            this.Write(" T");
            
            #line 275 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            
            #line default
            #line hidden
            this.Write(" { get; private set; }\r\n");
            
            #line 276 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

}

            
            #line default
            #line hidden
            this.Write("\r\n        private ");
            
            #line 280 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(className));
            
            #line default
            #line hidden
            this.Write("(IList<");
            
            #line 280 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.TreeNode));
            
            #line default
            #line hidden
            this.Write("> nodes)\r\n        {\r\n            if(nodes.Count != ");
            
            #line 282 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(prod.Length));
            
            #line default
            #line hidden
            this.Write(")\r\n            {\r\n                throw new ArgumentException(\"The list of nodes " +
                    "given is of the wrong length.\", \"nodes\");\r\n            }\r\n");
            
            #line 286 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

for(int i = 0; i < prod.Length; i++)
{

            
            #line default
            #line hidden
            this.Write("            T");
            
            #line 290 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            
            #line default
            #line hidden
            this.Write(" = (");
            
            #line 290 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(prod[i].Name));
            
            #line default
            #line hidden
            this.Write(")nodes[");
            
            #line 290 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(i));
            
            #line default
            #line hidden
            this.Write("];\r\n");
            
            #line 291 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

}

            
            #line default
            #line hidden
            this.Write("        }\r\n\r\n        public static ");
            
            #line 296 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(className));
            
            #line default
            #line hidden
            this.Write(" ");
            
            #line 296 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.ReduceByMethodName));
            
            #line default
            #line hidden
            this.Write("(Stack<");
            
            #line 296 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.TreeNode));
            
            #line default
            #line hidden
            this.Write("> parseStack)\r\n        {\r\n            //reverse the nodes because they are popped" +
                    " off in the inverted order.\r\n            var nodes = new ");
            
            #line 299 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Constants.TreeNode));
            
            #line default
            #line hidden
            this.Write("[]\r\n            {\r\n");
            
            #line 301 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

for(int i = 0; i < prod.Length; i++)
{

            
            #line default
            #line hidden
            this.Write("                parseStack.Pop(),\r\n");
            
            #line 306 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

}

            
            #line default
            #line hidden
            this.Write("            }.Reverse().ToArray();\r\n            return new ");
            
            #line 310 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(className));
            
            #line default
            #line hidden
            this.Write("(nodes);\r\n        }\r\n\r\n\t\tpublic override void AcceptVisitor(TreeVisitorBase visit" +
                    "or)\r\n        {\r\n            visitor.Visit(this);\r\n        }\r\n    }\r\n\r\n");
            
            #line 319 "C:\Projects\MParse\MParse.OutputGenerators\ParserTemplate.tt"

}

            
            #line default
            #line hidden
            this.Write("} //End Namespace\r\n\r\n");
            return this.GenerationEnvironment.ToString();
        }
    }
    
    #line default
    #line hidden
}
